---
import { sanityClient } from 'sanity:client';
import type { Page } from '../lib/sanityTypes';
import Logo from '../assets/logo.svg';
import Button from './Button.astro';

const pages = await sanityClient.fetch<
  Page[]
>(`*[_type == "page" && showInMenu == true && isHome != true] | order(orderRank asc) {
  title,
  slug
}`);

const page_home = await sanityClient.fetch<Page>(
  `*[_type == "page" && isHome == true][0] { title }`
);

interface Props {
  title: string;
}

const { title } = Astro.props;

const currentPath = Astro.url.pathname;
const getNavClass = (isActive: boolean) =>
  isActive ? 'text-foreground-primary' : 'text-foreground-secondary';
---

<header
  class="bg-background text-sm flex justify-between items-center sm:grid sm:grid-cols-3 py-5 gap-4 sm:gap-6 relative z-50"
>
  <!-- Logo -->
  <div class="flex items-start">
    <a href="/" class="flex items-center gap-2 font-display text-lg font-semibold tracking-wide">
      <Logo class="text-blue-600 size-6" />
      {title}
    </a>
  </div>

  <!-- Navigation -->
  <nav class="hidden sm:flex justify-center gap-8">
    <a href="/" class={getNavClass(currentPath === '/')}>{page_home.title}</a>
    <a href="/work" class={getNavClass(currentPath.startsWith('/work'))}>Work</a>
    {
      pages.map((page) => (
        <a
          href={`/${page.slug?.current}`}
          class={getNavClass(currentPath === `/${page.slug?.current}`)}
        >
          {page.title}
        </a>
      ))
    }
  </nav>

  <!-- Call to action -->
  <div class="hidden sm:flex justify-end items-center gap-2">
    <Button text="Socials" href="/socials" variant="tertiary" />
    <Button text="Contact" href="/contact" variant="secondary" />
  </div>

  <!-- Mobile Navigation Toggle -->
  <button
    class="sm:hidden w-6 h-6 flex flex-col justify-center gap-2 relative"
    aria-expanded="false"
    aria-label="Toggle navigation"
    id="burger-button"
  >
    <span
      class="burger-line block w-full h-0.5 bg-current transition-all duration-200 rounded-full origin-center translate-y-"
    ></span>
    <span
      class="burger-line block w-full h-0.5 bg-current transition-all duration-200 rounded-full origin-center"
    ></span>
  </button>
</header>

<!-- Mobile Navigation -->
<nav
  class="fixed inset-x-0 top-0 h-dvh -translate-y-full not-aria-hidden:translate-y-0 transition-transform duration-500 ease-out pt-16 md:hidden z-40"
  aria-hidden="true"
  id="mobile-nav"
>
  <div
    class="bg-background mx-auto px-4 py-8 flex flex-col gap-6 text-2xl h-full overflow-y-scroll"
  >
    <a
      href="/"
      class={`nav-item opacity-0 ${getNavClass(currentPath === '/')}`}
      style="--delay: 0.1s"
    >
      {page_home.title}
    </a>
    <a
      href="/work"
      class={`nav-item opacity-0 ${getNavClass(currentPath.startsWith('/work'))}`}
      style="--delay: 0.2s"
    >
      Work
    </a>
    {
      pages.map((page, index) => (
        <a
          href={`/${page.slug?.current}`}
          class={`nav-item opacity-0 ${getNavClass(currentPath === `/${page.slug?.current}`)}`}
          style={`--delay: ${0.3 + index * 0.1}s`}
        >
          {page.title}
        </a>
      ))
    }
    <a
      href="/socials"
      class="nav-item opacity-0 text-gray-500 dark:text-gray-400"
      style={`--delay: ${0.3 + pages.length * 0.1}s`}
    >
      Socials
    </a>
    <a
      href="/contact"
      class="nav-item opacity-0 text-gray-500 dark:text-gray-400"
      style={`--delay: ${0.4 + pages.length * 0.1}s`}
    >
      Contact
    </a>
  </div>
</nav>

<style>
  button[aria-expanded='true'] .burger-line:first-child {
    transform: translateY(5px) rotate(45deg);
  }

  button[aria-expanded='true'] .burger-line:last-child {
    transform: translateY(-5px) rotate(-45deg);
  }

  nav[aria-hidden='false'] .nav-item {
    animation: fadeInUp 0.4s ease-out forwards;
    animation-delay: var(--delay, 0s);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const button = document.getElementById('burger-button');
  const nav = document.getElementById('mobile-nav');
  const body = document.body;

  button?.addEventListener('click', () => {
    const isOpen = button.getAttribute('aria-expanded') === 'true';

    button.setAttribute('aria-expanded', String(!isOpen));
    nav?.setAttribute('aria-hidden', String(isOpen));
    body.setAttribute('aria-expanded', String(!isOpen));
  });

  nav?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      button?.setAttribute('aria-expanded', 'false');
      nav?.setAttribute('aria-hidden', 'true');
      body.setAttribute('aria-expanded', 'false');
    });
  });
</script>
